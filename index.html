<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Dash Ultra Fix</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap');
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body { background: #050505; overflow: hidden; font-family: 'Orbitron', sans-serif; color: white; touch-action: none; }
        canvas { display: block; }
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); text-align: center; padding: 20px; }
        .hidden { display: none !important; }
        .btn { background: linear-gradient(135deg, #ff00cc, #333399); border: 2px solid #fff; color: white; padding: 15px 30px; font-size: 18px; border-radius: 50px; margin: 10px; cursor: pointer; font-weight: 900; min-width: 200px; text-transform: uppercase; }
        .btn-small { background: #222; border-color: #00ffcc; padding: 10px 20px; font-size: 14px; min-width: 140px; }
        .leaderboard { background: rgba(255,255,255,0.05); border-radius: 15px; width: 100%; max-width: 320px; margin: 15px 0; padding: 15px; min-height: 80px; }
        .row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 13px; }
        #hud { position: absolute; top: 20px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; z-index: 50; pointer-events: none; font-size: 20px; }
        input { background: #111; border: 1px solid #ff00cc; color: white; padding: 12px; border-radius: 10px; text-align: center; margin-bottom: 15px; font-family: 'Orbitron'; width: 220px; }
    </style>
</head>
<body>

<div id="hud" class="hidden">
    <div id="hudScore">0</div>
    <div id="hudCoins" style="color: #ffd700;">üí∞ 0</div>
</div>

<canvas id="gameCanvas"></canvas>

<div id="screenMenu" class="screen">
    <h1 style="color: #ff00cc; font-size: 32px; text-shadow: 0 0 15px #ff00cc; margin-bottom: 15px;">NEON DASH</h1>
    <input type="text" id="playerName" placeholder="–¢–í–û–ô –ù–ò–ö" maxlength="10">
    <div class="leaderboard" id="globalBoardMenu">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <button class="btn" onclick="startGame()">–ò–ì–†–ê–¢–¨</button>
</div>

<div id="screenOver" class="screen hidden">
    <h2 style="color: #ff3333;">–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê</h2>
    <div id="finalScore" style="font-size: 50px; margin: 5px 0;">0</div>
    <p style="color: #ffd700; margin-bottom: 10px;">–ú–û–ù–ï–¢–´: +<span id="sessionCoins">0</span></p>
    <div class="leaderboard" id="globalBoardOver"></div>
    <button class="btn" onclick="startGame()">–ï–©–Å –†–ê–ó</button>
    <button class="btn btn-small" onclick="backToMenu()">–í –ú–ï–ù–Æ</button>
</div>

<script>
    // –¢–≤–æ–π –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π ID
    const BIN_ID = "22228939e981de6b7c03"; 
    const API_URL = `https://api.npoint.io/${BIN_ID}`;

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let storage = JSON.parse(localStorage.getItem('neonDashData')) || { coins: 0, name: '' };
    if(storage.name) document.getElementById('playerName').value = storage.name;

    let isPlaying = false, score = 0, coinsSession = 0, frame = 0, speed = 1;
    let playerX = window.innerWidth/2, targetX = playerX, enemies = [], dropCoins = [];

    window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;

    const move = (e) => { let x = e.touches ? e.touches[0].clientX : e.clientX; targetX = x; };
    window.addEventListener('touchmove', e => { if(isPlaying) e.preventDefault(); move(e); }, {passive: false});
    window.addEventListener('mousemove', move);

    async function getTop(id) {
        const board = document.getElementById(id);
        try {
            const res = await fetch(API_URL);
            if (!res.ok) throw new Error();
            let data = await res.json();
            if(!Array.isArray(data)) data = [];
            let html = '<div style="color:#00ffcc; font-size:12px">–ì–õ–û–ë–ê–õ–¨–ù–´–ô –†–ï–ô–¢–ò–ù–ì</div>';
            data.slice(0, 5).forEach((s, i) => {
                html += `<div class="row"><span>${i+1}. ${s.name}</span><span>${s.score}</span></div>`;
            });
            board.innerHTML = html || "–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–æ—Ä–¥–æ–≤";
        } catch(e) { board.innerHTML = "<span style='color:gray'>–û—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º</span>"; }
    }

    async function sendTop(name, val) {
        try {
            const res = await fetch(API_URL);
            let data = await res.json();
            if(!Array.isArray(data)) data = [];
            data.push({name, score: Math.floor(val)});
            data.sort((a,b) => b.score - a.score);
            await fetch(API_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data.slice(0, 10))
            });
            getTop('globalBoardOver');
        } catch(e) {}
    }

    function startGame() {
        storage.name = document.getElementById('playerName').value || "–ü–∏–ª–æ—Ç";
        localStorage.setItem('neonDashData', JSON.stringify(storage));
        isPlaying = true; score = 0; coinsSession = 0; frame = 0; speed = 1;
        enemies = []; dropCoins = [];
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById('hud').classList.remove('hidden');
        loop();
    }

    function backToMenu() {
        document.getElementById('screenOver').classList.add('hidden');
        document.getElementById('screenMenu').classList.remove('hidden');
        document.getElementById('hud').classList.add('hidden');
        getTop('globalBoardMenu');
    }

    function loop() {
        if(!isPlaying) return;
        ctx.fillStyle = 'rgba(5, 5, 12, 0.4)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        frame++; score += 0.15; speed = 1 + (score / 1500);
        playerX += (targetX - playerX) * 0.2;

        ctx.fillStyle = '#00ffff'; ctx.shadowBlur = 10; ctx.shadowColor = '#00ffff';
        ctx.fillRect(playerX - 15, canvas.height - 100, 30, 30); ctx.shadowBlur = 0;

        if(frame % Math.floor(50/speed) === 0) enemies.push({x: Math.random()*canvas.width, y: -50, v: 5*speed});
        enemies.forEach((e, i) => {
            e.y += e.v; ctx.fillStyle = '#ff0055'; ctx.fillRect(e.x-15, e.y, 30, 30);
            if(Math.abs(playerX - e.x) < 25 && Math.abs(canvas.height-85 - e.y) < 25) endGame();
            if(e.y > canvas.height) enemies.splice(i, 1);
        });

        if(frame % 100 === 0) dropCoins.push({x: Math.random()*canvas.width, y: -50, v: 4*speed});
        dropCoins.forEach((c, i) => {
            c.y += c.v; ctx.fillStyle = '#ffd700'; ctx.beginPath(); ctx.arc(c.x, c.y, 8, 0, Math.PI*2); ctx.fill();
            if(Math.hypot(playerX - c.x, (canvas.height-85) - c.y) < 25) { coinsSession++; dropCoins.splice(i, 1); }
            if(c.y > canvas.height) dropCoins.splice(i, 1);
        });

        document.getElementById('hudScore').innerText = Math.floor(score);
        document.getElementById('hudCoins').innerText = "üí∞ " + coinsSession;
        requestAnimationFrame(loop);
    }

    function endGame() {
        isPlaying = false;
        storage.coins += coinsSession;
        localStorage.setItem('neonDashData', JSON.stringify(storage));
        document.getElementById('finalScore').innerText = Math.floor(score);
        document.getElementById('sessionCoins').innerText = coinsSession;
        document.getElementById('screenOver').classList.remove('hidden');
        sendTop(storage.name, score);
    }

    getTop('globalBoardMenu');
</script>
</body>
</html>